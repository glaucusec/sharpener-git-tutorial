<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Daily Expenses</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.1.3/dist/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous"></head>
<body>
    <div class="container">
        <div class="row">
            <div class="col-12">
                <h1 class="display-1" style="text-align: center;">Expense Tracker</h1>
            </div>
        </div>
        <div class="row">
            <form id="expense-form">
                <div class="mb-3">
                    <input hidden type="number" name="id" class="form-control" id="idInputBox">    
                </div>
                <div class="mb-3">
                    <label for="amountInput" class="form-label">Amount Input</label>
                    <input type="number" name="amount" placeholder="Enter the Amount" class="form-control" id="amountInputBox">    
                </div>
                <div class="mb-3">
                    <label for="description"  class="form-label">Description</label>
                    <input type="text" name="description" class="form-control" placeholder="Write the description" id="descInputBox"> 
                </div>
                <div class="mb-3">
                    <label for="category" class="form-label">Category</label>
                    <select name="category" class="form-select" id="catInputBox">
                        <option>Fuel</option>
                        <option>Entertainment</option>
                        <option>Beauty/Wellness</option>
                        <option>Pets</option>
                        <option>Shopping</option>
                    </select>
                </div>

                <div class="row">
                    <div class="col">
                        <button type="submit" class="btn btn-info">Submit</button>
                    </div>
                    <div class="col">
                        <button class="btn btn-info" id="rzp-button1">Buy Premium</button>
                    </div>
                    <div class="col">
                        <p class="btn" id="premiumText"></p>
                    </div>
                    <div class="col">
                        <button class="btn btn-info" id="report-button">See Report</button>
                    </div>
                    <div class="col">
                        <a href="http://localhost:3000/premium/report" target="_blank" class="btn btn-info" id="leaderboard-button">Show LeaderBoard</a>
                    </div>
                </div>
                <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
            </form>
            <div class="mb-3">
                <hr>
            </div>
        </div>

        <table class="table">
            <thead  class="thead">
                <tr>
                    <th scope="col">#</th>
                    <th scope="col">Amount</th>
                    <th scope="col">Description</th>
                    <th scope="col">Category</th>
                    <th scope="col">Delete</th>
                    <th scope="col">Edit</th>
                </tr>
            </thead>
            <tbody class="tbody">

            </tbody>
        </table>

        <div id="leaderboard-section" style="display: none;">
            <h3 class="text-center">LeaderBoard</h3>
            <table class="table">
                <thead class="thead-dark">
                    <tr>
                        <th scope="col">Name</th>
                        <th scope="col">Total Amount</th>
                    </tr>
                </thead>
                <tbody id="tbody-leaderboard">

                </tbody>
            </table>
        </div>
        <div id="report-section" style="display: block;">
            <h3 class="text-center">Report</h3>
            <table class="table table-bordered">
                <thead class="thead-dark">
                  <tr>
                    <th scope="col">Date</th>
                    <th scope="col">Description</th>
                    <th scope="col">Category</th>
                    <th scope="col">Income</th>
                    <th scope="col">Expense</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td>01-02-2021</td>
                    <td>Milk</td>
                    <td>Milk</td>
                    <td>s</td>
                    <td>60.00</td>
                  </tr>
                  <tr>
                    <td>01-02-2021</td>
                    <td>Milk</td>
                    <td>Milk</td>
                    <td>s</td>
                    <td>60.00</td>
                  </tr>
                  <tr>
                    <td>01-02-2021</td>
                    <td>Milk</td>
                    <td>Milk</td>
                    <td>s</td>
                    <td>60.00</td>
                  </tr>
                  <tr>
                    <td colspan="4"></td>
                    <td>180</td>
                  </tr>
                </tbody>
              </table>
        </div>
    </div>

    
    <!-- <script src="index.js"></script> -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js" integrity="sha384-w76AqPfDkMBDXo30jS1Sgez6pr3x5MlQ1ZAGC+nuZB+EYdgRZgiwxhTBTkF7CXvN" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.14.3/dist/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.1.3/dist/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>

    

    <script>

        function showReport() {
            const reportSection = document.querySelector('#')
        }
        
        // Show LeaderBoard Functionconst showLeaderBoardButton = document.querySelector('#leaderboard-button');

        const leaderboardSection = document.querySelector('#leaderboard-section');
        const leaderboardBody = document.querySelector('#tbody-leaderboard');
        let isVisible = false

        document.querySelector('#leaderboard-button').addEventListener('click', async (e) => {
            e.preventDefault();
            await axios.post('http://localhost:3000/premium/leaderboard', {}, {
                headers: {
                    "Authorization": token
                }
            })
            .then(leaderboard => {
                leaderboardBody.innerHTML = '';
                leaderboard.data.forEach(user => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = '';
                    const tdName = document.createElement('td');
                    tdName.textContent = user.name;

                    const tdAmount = document.createElement('td');
                    tdAmount.textContent = user.totalAmount;

                    tr.appendChild(tdName);
                    tr.appendChild(tdAmount);

                    leaderboardBody.appendChild(tr);
                });


                
                if(isVisible) {
                    leaderboardSection.style.display = 'none';
                } else {
                    leaderboardSection.style.display = 'block'
                }
                isVisible = !isVisible;
            })
            .catch(err => console.log(err));
        })

        // Check if the use is already a existing Premium user.?
        const token = localStorage.getItem('token');
        async function hideOrNot () {
            await axios.post('http://localhost:3000/purchase/ispremium', null, {
                headers: {
                    "Authorization" : token
                }
            })
            .then(result => {
                if(result.data.isPremiumUser) {
                    const rzpButton = document.getElementById('rzp-button1');
                    rzpButton.style.display = 'none';
                    document.getElementById('premiumText').textContent = 'You are a Premium User';
                    document.getElementById('premiumText').style.fontWeight = 'bold';

                } else {
                    // Hide the  see report button if the user is not premium.
                }
                
            })
            .catch(err => console.log(err));
        }

        hideOrNot();

        const rzpButton = document.getElementById("rzp-button1");
        rzpButton.addEventListener('click', async (e) => {
            e.preventDefault();
    
            const token = localStorage.getItem('token');
            const response = await axios.post('http://localhost:3000/purchase/premium', null, {
                headers: {
                    "Authorization" : token
                }
            })
            let options = {
                "key": response.data.key_id, // Enter the Key ID generated from the Dashboard
                "amount": "50000", // Amount is in currency subunits. Default currency is INR. Hence, 50000 refers to 50000 paise
                "currency": "INR",
                "name": "Abhishek Corp", //your business name
                "description": "Test Transaction",
                "image": "https://example.com/your_logo",
                "order_id": response.data.orderId, //This is a sample Order ID. Pass the `id` obtained in the response of Step 1
                "handler": async function(res) {
                    const token = localStorage.getItem('token');
                    await axios.post('http://localhost:3000/purchase/updatetransactionstatus', {
                        success: true,
                        order_id: res.razorpay_order_id,
                        payment_id: res.razorpay_payment_id
                    }, {
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': token
                        }
                    }).then((res) => {
                        console.log(res);
                        alert('You are a Premium user');
                        window.location.href = 'http://localhost:3000/user/daily-expenses'
                    }).catch((error) => console.log(error));

                    
                },
                "prefill": {
                    "name": "Gaurav Kumar", //your customer's name
                    "email": "gaurav.kumar@example.com",
                    "contact": "9000090000"
                },
                "notes": {
                    "address": "Razorpay Corporate Office"
                },
                "theme": {
                    "color": "#3399cc"
                }
            };
            
            let rzp1 = new Razorpay(options);
            rzp1.open();
            rzp1.on('payment.failed', async function(response) {
                const token = localStorage.getItem('token');
                await axios.post('http://localhost:3000/purchase/updatetransactionstatus', {
                    success: false,
                    order_id: response.error.metadata.order_id,
                    payment_id: response.error.metadata.payment_id
                }, {
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': token
                    }
                })
                alert(response.error.description);
            })
        })

        const formEl = document.querySelector('#expense-form');
        // sending the form data to the backend

        formEl.addEventListener('submit', (e) => {
            e.preventDefault();
            const token = localStorage.getItem('token');
            const {result} = axios.post('http://localhost:3000/user/expenses', document.querySelector('#expense-form'), {
                headers: {
                   'Content-Type': 'application/json',
                   'Authorization': token
                }
            })
            .then(window.location.href = 'http://localhost:3000/user/daily-expenses');
        })
        
        const tbody = document.querySelector('.tbody'); 

        function addExpenseToScreen(expense) {
            const tr = document.createElement('tr');

            const tdId = document.createElement('td');
            tdId.textContent = expense.id;

            const tdAmount = document.createElement('td');
            tdAmount.textContent = expense.amount;

            const tdDesc = document.createElement('td');
            tdDesc.textContent = expense.description;

            const tdCategory = document.createElement('td');
            tdCategory.textContent = expense.category;

            // Adding the Delete Button
            const tdDelete = document.createElement('td');
            const delBtn = document.createElement('input');
            delBtn.type = 'button';
            delBtn.value = 'Delete';
            delBtn.classList.add('btn', 'btn-danger');
            delBtn.onclick = () => {
                let expense_id = expense.id;
                let token = localStorage.getItem('token');
                axios.delete('/user/delete', {
                    headers: {
                        'Authorization': token
                    },
                    data: {
                        id: expense_id
                    }
                })
                .then(window.location.href = 'http://localhost:3000/user/daily-expenses')
                .catch(err => console.log(err));
            }
            tdDelete.appendChild(delBtn);

            // Adding the Edit Button
            const tdEdit = document.createElement('td');
            const editBtn = document.createElement('input');
            editBtn.type = 'button';
            editBtn.value = 'Edit';
            editBtn.classList.add('btn', 'btn-warning');
            editBtn.onclick = () => {
                document.getElementById('idInputBox').value = expense.id;
                document.getElementById('amountInputBox').value = expense.amount;
                document.getElementById('descInputBox').value = expense.description;
                document.getElementById('catInputBox').value = expense.category;
            }
            tdEdit.appendChild(editBtn);

            tr.appendChild(tdId);
            tr.appendChild(tdAmount);
            tr.appendChild(tdDesc);
            tr.appendChild(tdCategory);
            tr.appendChild(tdDelete);
            tr.appendChild(tdEdit);

            tbody.appendChild(tr);
        }

        // Showing existing expenses.
        async function fetchExpenses() {
            const token = localStorage.getItem('token');
            let response = await axios.get('http://localhost:3000/user/expenses', {
                headers: {
                    "Authorization": token
                }
            });
            let data = response.data;
            data.forEach(expense => {
                addExpenseToScreen(expense);
            });
        }

        fetchExpenses();
    </script>

</body>
</html>